from flask import Flask, request
import requests
from bs4 import BeautifulSoup
import pandas as pd
import os
import re
import ftplib
import logging
from datetime import datetime, timedelta
import tempfile
import atexit
import shutil

app = Flask(__name__)
logging.basicConfig(level=logging.INFO)

# ========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# ========================
url = "http://pingwinclub.ru/"
ftp_host = os.getenv("FTP_HOST")
ftp_user = os.getenv("FTP_USER")
ftp_pass = os.getenv("FTP_PASS")
ftp_path = os.getenv("FTP_PATH")

# –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã
temp_dir = tempfile.mkdtemp(prefix="parser_")
html_file_path = os.path.join(temp_dir, "rating_full.html")

# –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
def cleanup():
    try:
        shutil.rmtree(temp_dir)
        print("üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã.")
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {e}")

atexit.register(cleanup)

# ========================
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
# ========================
def log(message):
    print(f"[{datetime.now().strftime('%H:%M:%S')}] {message}")

# ========================
# –ü–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞
# ========================
def run_parser():
    log("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Å–∞–π—Ç–∞")
    try:
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        html = response.text
        log("‚úÖ HTML —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω")
    except Exception as e:
        log(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∞–π—Ç–∞: {e}")
        return

    soup = BeautifulSoup(html, "html.parser")
    rows = soup.select("tr.stat")
    data = []
    for row in rows:
        cols = row.find_all("td")
        if len(cols) < 5:
            continue
        name_tag = cols[2].find(class_="statname")
        name = name_tag.get_text(strip=True) if name_tag else cols[2].get_text(strip=True)
        rating = cols[3].get_text(strip=True)
        delta = cols[4].get_text(strip=True)
        last_participation = "-"
        stats_div = cols[1].find("div", class_="podrstat")
        if stats_div:
            stats_text = stats_div.get_text(strip=True)
            match = re.search(r"–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—á–∞—Å—Ç–∏—è - ([\d\.]+)", stats_text)
            if match:
                last_participation = match.group(1)
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –¥—Ä—É–≥–∏—Ö —Å—Ç–æ–ª–±—Ü–∞—Ö, –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏
        if last_participation == "-":
            for i in [5, 6]:
                if len(cols) > i:
                    possible_date = cols[i].get_text(strip=True)
                    if re.fullmatch(r"\d{2}\.\d{2}\.\d{4}", possible_date):
                        last_participation = possible_date
                        break
        city = cols[7].get_text(strip=True) if len(cols) > 7 else "-"
        data.append([len(data) + 1, name, rating, delta, last_participation, city])

    df = pd.DataFrame(data, columns=["–ú–µ—Å—Ç–æ", "–ò–º—è", "–†–µ–π—Ç–∏–Ω–≥", "Œî –†–µ–π—Ç–∏–Ω–≥", "–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ", "–ì–æ—Ä–æ–¥"])

    # --- –§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –∏–≥—Ä–æ–∫–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞ ---
    df['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'] = pd.to_datetime(df['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'], format='%d.%m.%Y', errors='coerce', dayfirst=True)

    three_months_ago = datetime.now() - timedelta(days=90)  # ~3 –º–µ—Å—è—Ü–∞
    df_filtered = df[df['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'].notna() & (df['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'] >= three_months_ago)]
    df_filtered = df_filtered.sort_values(by='–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ', ascending=False).reset_index(drop=True)
    df_filtered['–ú–µ—Å—Ç–æ'] = df_filtered.index + 1
    df_filtered['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'] = df_filtered['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'].dt.strftime('%d.%m.%Y')
    # ---

    df = df_filtered

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–∞—Ç—É —É—á–∞—Å—Ç–∏—è
    latest_date_str = "-"
    if not df.empty:
        latest_date = pd.to_datetime(df['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ'], format='%d.%m.%Y', errors='coerce').max()
        if not pd.isna(latest_date):
            latest_date_str = latest_date.strftime('%d.%m.%Y')

    log(f"üìÖ –ü–æ—Å–ª–µ–¥–Ω—è—è –¥–∞—Ç–∞ —Ç—É—Ä–Ω–∏—Ä–∞ (–ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏): {latest_date_str}")

    # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä–≤—ã–µ –±—É–∫–≤—ã —Ñ–∞–º–∏–ª–∏–π
    used_letters = set()
    for _, row in df.iterrows():
        surname = row['–ò–º—è'].strip().split()[0] if row['–ò–º—è'].strip() else ""
        if surname and surname[0].isalpha():
            used_letters.add(surname[0].upper())

    letters = [chr(c) for c in range(ord("–ê"), ord("–Ø") + 1)]
    filtered_letters = sorted([l for l in letters if l in used_letters])
    half = len(filtered_letters) // 2
    first_row = filtered_letters[:half]
    second_row = filtered_letters[half:]

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
    html_content = f"""
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>–†–µ–π—Ç–∏–Ω–≥ PingWinClub</title>
        <style>
            body {{
                font-family: Arial, sans-serif;
                margin: 20px;
                background-color: #f9f9f9;
                color: #333;
                line-height: 1.5;
            }}
            h1 {{
                text-align: center;
                color: #2c3e50;
                margin-bottom: 10px;
                font-size: 1.5em;
            }}
            h3 {{
                text-align: center;
                color: #777;
                margin-bottom: 20px;
                font-size: 1em;
            }}
            h4 {{
                margin-top: 20px;
                margin-bottom: 10px;
                font-size: 1em;
            }}
            .filters {{
                margin-bottom: 20px;
            }}
            .filter-row {{
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 10px;
            }}
            .filter-btn {{
                padding: 6px 10px;
                background: #2ecc71;
                color: white;
                cursor: pointer;
                border-radius: 4px;
                font-size: 0.9em;
                flex: 1 1 auto;
                text-align: center;
                min-width: 40px;
            }}
            .filter-btn:hover {{
                background: #27ae60;
            }}
            .alffilter {{
                padding: 6px 10px;
                background: #3498db;
                color: white;
                cursor: pointer;
                border-radius: 4px;
                font-size: 0.9em;
                flex: 1 1 auto;
                text-align: center;
                min-width: 30px;
            }}
            .alffilter:hover {{
                background: #2980b9;
            }}
            table {{
                border-collapse: collapse;
                width: 100%;
                background-color: white;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                font-size: 0.9em;
            }}
            th, td {{
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }}
            th {{
                background-color: #3498db;
                color: white;
            }}
            .centered {{
                text-align: center;
            }}
            tr:nth-child(even) {{
                background-color: #f2f2f2;
            }}
            tr:hover {{
                background-color: #e0e0e0;
            }}
        </style>
    </head>
    <body>
        <h1><a href="https://–ø–∏–Ω–≥–≤–∏–Ω–∫–ª—É–±.—Ä—Ñ/reitingi.html" target="_blank">–†–µ–π—Ç–∏–Ω–≥ PingWinClub</a></h1>
        <h3>–ö–ª—É–±–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥ –∑–∞ –ø—Ä–æ—à–µ–¥—à–∏–µ 3 –º–µ—Å—è—Ü–∞</h3>
        <div class="filters">
            <h4>–ê–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä:</h4>
            <div class="filter-row">
                <span class="alffilter" data-letter="–≤—Å–µ">–í–°–ï</span>
                {"".join(f'<span class="alffilter" data-letter="{l}">{l}</span>' for l in first_row)}
            </div>
            <div class="filter-row">
                {"".join(f'<span class="alffilter" data-letter="{l}">{l}</span>' for l in second_row)}
            </div>
            <h4 style="margin-top: 20px;">–§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ç—É—Ä–Ω–∏—Ä—É:</h4>
            <div class="filter-row">
                <span class="filter-btn" data-date="{latest_date_str}">–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç—É—Ä–Ω–∏—Ä: {latest_date_str}</span>
            </div>
        </div>
        <table id="myTable" border="1">
            <thead>
                <tr>
                    <th class="centered">‚Ññ</th>
                    <th>–ò–º—è</th>
                    <th class="centered">–†–µ–π—Ç–∏–Ω–≥</th>
                    <th class="centered">Œî</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ</th>
                    <th>–ì–æ—Ä–æ–¥</th>
                </tr>
            </thead>
            <tbody>
    """

    for _, row in df.iterrows():
        delta = row['Œî –†–µ–π—Ç–∏–Ω–≥']
        rating = row['–†–µ–π—Ç–∏–Ω–≥']
        rating_style = ''
        if '+' in delta and delta not in ["+0", "+-0"]:
            rating_style = 'style="color: darkgreen; font-weight: bold;"'
        elif '-' in delta and delta not in ["-0", "+-0"]:
            rating_style = 'style="color: red; font-weight: bold;"'

        html_content += f"""
        <tr>
            <td class="centered">{row['–ú–µ—Å—Ç–æ']}</td>
            <td>{row['–ò–º—è']}</td>
            <td class="centered" {rating_style}>{rating}</td>
            <td class="centered">{delta}</td>
            <td class="last-activity">{row['–ü–æ—Å–ª–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∏–µ']}</td>
            <td>{row['–ì–æ—Ä–æ–¥']}</td>
        </tr>
        """

    html_content += """
            </tbody>
        </table>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const alffilters = document.querySelectorAll(".alffilter");
                const datefilters = document.querySelectorAll(".filter-btn");
                const rows = document.querySelectorAll("#myTable tbody tr");

                alffilters.forEach(filter => {
                    filter.addEventListener("click", function () {
                        const letter = this.getAttribute("data-letter").toLowerCase();
                        rows.forEach(row => {
                            const nameCell = row.querySelector("td:nth-child(2)");
                            if (!nameCell) return;
                            const surname = nameCell.textContent.trim().split(" ")[0];
                            const firstLetter = surname.charAt(0).toUpperCase();
                            if (letter === "–≤—Å–µ" || firstLetter === letter) {
                                row.style.display = "";
                            } else {
                                row.style.display = "none";
                            }
                        });
                    });
                });

                datefilters.forEach(filter => {
                    filter.addEventListener("click", function () {
                        const targetDate = this.getAttribute("data-date");
                        rows.forEach(row => {
                            const dateCell = row.querySelector("td.last-activity");
                            if (!dateCell) return;
                            const rowDate = dateCell.textContent.trim();
                            if (targetDate === "all" || rowDate === targetDate) {
                                row.style.display = "";
                            } else {
                                row.style.display = "none";
                            }
                        });
                    });
                });
            });
        </script>
    </body>
    </html>
    """

    # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º HTML –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    try:
        with open(html_file_path, "w", encoding="utf-8") as f:
            f.write(html_content)
        log(f"‚úÖ HTML –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {html_file_path}")
    except Exception as e:
        log(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ HTML: {e}")
        return

    # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ FTP
    log("üì§ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞ FTP")
    try:
        with ftplib.FTP(ftp_host) as ftp:
            ftp.login(user=ftp_user, passwd=ftp_pass)
            log("‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ FTP")
            ftp.cwd(ftp_path)
            log(f"üìÅ –ü–µ—Ä–µ—à–ª–∏ –≤ –ø–∞–ø–∫—É: {ftp_path}")
            with open(html_file_path, "rb") as file:
                ftp.storbinary("STOR rating_full.html", file)
        log("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ FTP")
    except Exception as e:
        log(f"‚ùå –û—à–∏–±–∫–∞ FTP: {e}")
        return

    # –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    try:
        os.remove(html_file_path)
        log("üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π HTML-—Ñ–∞–π–ª —É–¥–∞–ª—ë–Ω")
    except Exception as e:
        log(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: {e}")

# ========================
# Flask –º–∞—Ä—à—Ä—É—Ç—ã
# ========================
@app.route("/")
def index():
    return "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω. –û—Ç–∫—Ä–æ–π—Ç–µ /run –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–µ—Ä–∞."

@app.route("/run")
def run():
    log("üîî –ó–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø—É—Å–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞")
    run_parser()
    return "‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω –∏ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ FTP"

# ========================
# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
# ========================
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port)
